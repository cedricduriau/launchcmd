#!/usr/bin/env python

# stdlib modules
import os
import argparse

# tool modules
from launchcmd import pathutils
from launchcmd import packageutils
from launchcmd import shellutils


def _build_parser():
    """Builds the command line interface.

    :rtype: argparse.ArgumentParser
    """
    description = "Lists installed package releases of levels."
    parser = argparse.ArgumentParser(prog="listpackges", description=description)

    # positional arguments
    helper = "relative or absolute location of level to list installed packages from"
    parser.add_argument("location", help=helper)

    # optional arguments
    helper = "if set, all packages installed on parent levels will be shown"
    parser.add_argument("-p", "--parents", action="store_true", help=helper)

    return parser


if __name__ == "__main__":
    parser = _build_parser()
    namespace = parser.parse_args()

    location = namespace.location
    parents = namespace.parents

    if parents:
        level_dirs = pathutils.get_level_directories(location)
    else:
        level_dirs = [pathutils.get_level_directory(location)]

    for level_dir in level_dirs:
        tags = packageutils.get_installed_packages_tags(level_dir)

        if tags:
            lines = shellutils.run_check_output("tput cols")
            width = int(lines[0])
            char_count = int((width - len(level_dir)) / 2)
            print("{0}{1}{0}".format("=" * char_count, level_dir))
            print(os.linesep.join(sorted(tags)))
